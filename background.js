        // uncomment to preload
        
        //"rockpapershotgun.com": true,
        //"www.rockpapershotgun.com": true,
        //"storify.com": true,
        //"twitter.com": true
        //"si0.twimg.com": true
        
// ["0.media.collegehumor.cvcdn.com","1.media.collegehumor.cvcdn.com","2.media.collegehumor.cvcdn.com","24.media.tumblr.com","25.media.tumblr.com","3.bp.blogspot.com","30.media.tumblr.com","www.40kforums.com","40kforums.com","4sq.com","www.7digital.com","999-async.olark.com","a0.twimg.com","a1.img.mobypicture.com","a1.media.mobyhub.com","a1.twimg.com","a2.sphotos.ak.fbcdn.net","a2.twimg.com","a3.img.mobypicture.com","a3.sphotos.ak.fbcdn.net","a3.twimg.com","a4.sphotos.ak.fbcdn.net","a5.sphotos.ak.fbcdn.net","www.addictinggames.com","adf.ly","www.adjustyourset.tv","ads.eurogamer.net","amazon-zg.s3.amazonaws.com","analytics.freedom.com","www.animal-space.net","anywhere.platform.twitter.com","api.ak.facebook.com","api.brightcove.com","api.embed.ly","api.facebook.com","api.flickr.com","api.freebase.com","api.plixi.com","api.soundcloud.com","art.penny-arcade.com","assets.tumblr.com","auth.curse.com","badge.stumbleupon.com","badlyrecreatedanimatedfilmframes.tumblr.com","beatms.mssociety.org.uk","www.belloflostsouls.net","bitzbox.co.uk","www.bitzbox.co.uk","blog.geeksaresexytech.netdna-cdn.com","bragitup.tumblr.com","www.break.com","www.brothersoft.com","btothef.tumblr.com","buttons.reddit.com","www.buzzbuttons.com","c.brightcove.com","c.markosweb.com","cdn.buzznet.com","cdn.dev.24wired.tv","cdn.extensions.buzznet.com","cdn.formspring.me","cdn.livechatinc.com","cdn.medialib.computerandvideogames.com","cdn.mobify.com","cdn.optimizely.com","cdn.socialtwist.com","cdn.static.computerandvideogames.com","cdn.steamcommunity.com","cdn.steampowered.com","cdn.store.steampowered.com","cdn.wibiya.com","cdn1.addictinggames.com","cdn1.diggstatic.com","cdn2.addictinggames.com","cdn2.diggstatic.com","cdn2.sbnation.com","cdn3.addictinggames.com","cdn3.diggstatic.com","cfiles.5min.com","cim.meebo.com","cloud.github.com","cloud.steampowered.com","cnettv.cnet.com","codiqa.com","www.computerandvideogames.com","www.connect.facebook.com","connect.facebook.net","content6.flixster.com","content7.flixster.com","ct.buzzfeed.com","www.cyberweb.fr","d3b5o0hvas6w3c.cloudfront.net","d3c3cq33003psk.cloudfront.net","d3j5vwomefv46c.cloudfront.net","www.davelgil.com","dev.24wired.tv","dev.wikia.com","www.digital-kaos.co.uk","dlvr.it","www.doublefine.com","download.unity3d.com","downloads.bbc.co.uk","dragcave.net","www.e4.com","edge.sharethis.com","engine.gamerati.net","error.facebook.com","www.eurogamer.net","facebook.com","www.facebook.com","farm1.static.flickr.com","farm3.static.flickr.com","farm6.static.flickr.com","farm7.static.flickr.com","farm8.static.flickr.com","farm9.static.flickr.com","fast.fonts.com","fb.me","fbcdn-sphotos-c-a.akamaihd.net","feeds.games-workshop.com","files-cdn.formspring.me","files.posterous.com","files.privateerpress.com","flic.kr","www.flickr.com","www.forgeworld.co.uk","www.formspring.me","forum.divxplanet.com","forum.leaguecraft.com","forums.gametrailers.com","www.freegaming.de","g2.img-dpreview.com","www.gamefaqs.com","gamercard.xbox.com","www.games-workshop.com","www.gametrailers.com","geekpinata.tumblr.com","geobanner.fastcupid.com","getoutoftherecat.tumblr.com","www.giantitp.com","gifmovie.tumblr.com","gifsoup.com","gipegremlins.tumblr.com","goku.brightcove.com","graph.facebook.com","graphics.fastcupid.com","greywolf.critter.net","www.heresy-online.net","hits.guardian.co.uk","hm.webtrends.com","horseysurprise.tumblr.com","htmlimg2.scribdassets.com","i.crackedcdn.com","i.minus.com","i.zemanta.com","i1101.photobucket.com","i1103.photobucket.com","i1109.photobucket.com","i1139.photobucket.com","i1177.photobucket.com","i1262.photobucket.com","i234.photobucket.com","i238.photobucket.com","i292.photobucket.com","i382.photobucket.com","i429.photobucket.com","i48.tinypic.com","i522.photobucket.com","i570.photobucket.com","i606.photobucket.com","i65.photobucket.com","i864.photobucket.com","i876.photobucket.com","iglo.tk","image.aimoo.com","image.pushauction.com","images.dailyexpress.co.uk","images.del.icio.us","images.eurogamer.net","images.huffingtonpost.com","images.reevoo.com","images.socialtwist.com","images.vg247.com","img.gamefaqs.net","img.imtwelve.com","img.photobucket.com","img.widgetbox.com","img.zemanta.com","img3.catalog.video.msn.com","img3i.www.spoki.lv","imgv2-2.scribdassets.com","include.reinvigorate.net","www.indiegamemag.com","www.indiegames.com","indiegames.com","indiegames.disqus.com","www.indiegogo.com","instagram.com","internetometer.com","www.ivstatic.com","www.jackpotjoy.com","www.joystiq.com","knowyourmeme.a.ec.viddler.com","kotaku.com","l-stat.livejournal.com","l-userpic.livejournal.com","l.sharethis.com","www.l4d.com","layout.mobypicture.com","www.librarium-online.com","www.linksalpha.com","livefyre-avatar.s3.amazonaws.com","www.liveleak.com","www.loadedweb.com","log.maniacalrage.net","log.olark.com","www.lolhome.com","www.lounge.belloflostsouls.net","www.ludumdare.com","lukehimself.net","lxjs.tumblr.com","m.webtrends.com","machiavelliscat.com","mail.google.com","mail.yahoo.co.uk","media.disqus.com","media.howcast.com","media.mtvnservices.com","media.sfx.co.uk","media.sportingindex.com","media.steampowered.com","media.tumblr.com","media1.onsugar.com","mediacdn.disqus.com","mimg.ugo.com","www.minecraft.net","miniprofile.xfire.com","www.miniwargaming.com","www.mobypicture.com","mofarahrunningawayfromthings.tumblr.com","moviegifss.tumblr.com","www.mtv.com","n4g.com","www.national-lottery.co.uk","neomorte.com","open.spotify.com","orangegripes.tumblr.com","osc.optimize.webtrends.com","ots.optimize.webtrends.com","p.media-imdb.com","p.twimg.com","p.twitter.com","pbs.twimg.com","www.pcpowerplay.com.au","photos17.flickr.com","photos4.meetupstatic.com","pics4.inxhost.com","platform.stumbleupon.com","platform.tumblr.com","platform.twitter.com","platform0.twitter.com","www.plurk.com","plus.google.com","profiles.joystiq.com","progressquest.com","pshared.5min.com","www.publicproxyservers.com","publish.redorbit.com","r.twimg.com","ramp.ie.nyud.net","rawbdz.tumblr.com","www.readwriteweb.com","www.reddit.com","reddit.com","www.retrogamer.net","rich.buzznet.com","richardbransonpickingupwomen.tumblr.com","www.rockpapershotgun.com","rockpapershotgun.com","rumdoings.jellycast.com","ryannorth.tumblr.com","s-ak.buzzfed.com","s-static.ak.facebook.com","s.media-imdb.com","s.webtrends.com","s0.jrnl.ie","s2.n4g.com","s3-ak.buzzfed.com","s3.amazonaws.com","s3.greatgatsbygame.com","sas-origin.onstreammedia.com","www.scrabblefinder.com","scrolls.com","search.twitter.com","seg.sharethis.com","server.lon.liveperson.net","service.o2.co.uk","services.digg.com","sexquestionsfromseventhgraders.tumblr.com","www.shrimpnow.com","si0.twimg.com","siracusa.tumblr.com","www.skype.co.uk","www.socialmediabuttons.com","www.somesoundswelike.com","sparxmind.com","sr4.liveperson.net","st.e4.com","static.daylife.com","static.eurogamer.net","static.flickr.com","static.gamerati.net","static.jackpotjoy.com","static.mobypicture.com","static.olark.com","static.ow.ly","static.tumblr.com","stats.storify.com","steamcommunity.com","store.storeimages.cdn-apple.com","storefront.steampowered.com","storify.com","www.stumbleupon.com","syn.5min.com","sync.tidaltv.com","t.co","taitems.tumblr.com","www.technologyreview.com","theamazingios6maps.tumblr.com","www.thedarkfortress.co.uk","theslingshot.com","theweaselking.livejournal.com","thingshussiebought.tumblr.com","thumbs.reddit.com","tipseri.net","tmblr.co","topix.cachefly.net","track.reinvigorate.net","www.tv.com","twibbon.com","unewz.tumblr.com","unfuckyourhabitat.tumblr.com","use.typekit.com","userserve-ak.last.fm","www.vg247.com","video.google.com","vintage-ads.livejournal.com","virtualgeographic.tumblr.com","vox-static.liverail.com","w.sharethis.com","w.soundcloud.com","www.wadjeteyegames.com","www.warhammer-empire.com","warhammer-empire.com","www.warseer.com","www.warvault.net","www.waylandgames.co.uk","wd-edge.sharethis.com","wd.sharethis.com","widget.meebo.com","widgets.digg.com","widgets.twimg.com","worldofstuart.excellentcontent.com","www.worthpoint.com","www.wowhead.com","wp.patheos.com.s3.amazonaws.com","wstat.wibiya.com","xc3.services.livejournal.com","yourplacenotmine.tumblr.com","youtu.be","www.youtube-nocookie.com","z.about.com","zapp5.staticworld.net","www.zergnet.com","i1051.photobucket.com","bitsandpieces1.blogspot.be"]
        
var domainsJSON = localStorage.getItem("domains"),
    forbiddenStatus = 403,
    forbiddenStatusRe = /^HTTP\/[0-9.]+ 403/,
    sneakSuffix = ".mcsneak.jit.su";

/*
 * whitelist: domains that are always bypassed
 * blacklist: domains that are never bypassed
 */

var DomainModel = Backbone.Model.extend({
    localStorage: new Backbone.LocalStorage("DomainModel"),
    initialize: function () {
        if (this.get("white") === undefined) this.set("white", []);
        if (this.get("black") === undefined) this.set("black", []);
    },
    whitelist: function (domain) {
        this.removeFromList("black", domain);
        this.addToList("white", domain);
    },
    blacklist: function (domain) {
        this.removeFromList("white", domain);
        this.addToList("black", domain);
    },
    addToList: function (listName, domain) {
        list = _(this.get(listName));
        if ( ! list.contains(domain)) {
            var idx = list.sortedIndex(domain);
            list.splice(idx, 0, domain);
        }
        this.set(listName, list.value());
        this.save();
        this.trigger(listName + "list", domain);
    },
    removeFromList: function (listName, domain) {    
        this.set(listName, _(this.get(listName)).without(domain));
        this.save();
        this.trigger("un" + listName + "list", domain);
    },
    isWhitelisted: function (domain) {
        return this.isOnList("white", domain);
    },
    isBlacklisted: function (domain) {
        return this.isOnList("black", domain);
    },
    isOnList: function (list, domain) {
        return _(this.get(list)).contains(domain);
    },
    getFilteredList: function(listName, substring) {
        //return this.get(listName);
        return _(this.get(listName)).filter(function(domain){
            return domain.indexOf(substring) >= 0;
        });
    }
});

window.model = new DomainModel({id: 0});

window.model.fetch();
    //domainsJSON? JSON.parse(domainsJSON) : {white: [], black: []});


// event handler fired before requests go out
// fired synchronously so opportunity to redirect if host name is known-bad
chrome.webRequest.onBeforeRequest.addListener(
    function(details) {
        var url = URL(details.url),
            host = url.host();
        if (model.isWhitelisted(host)) {
            url.host(host + sneakSuffix);
            return {redirectUrl: url.toString()};
        }
    },
    // filters
    {
        urls: ["<all_urls>"]
    },
     // extraInfoSpec
    ["blocking"] // make it synchronous
);


// event handler fired when request headers received
// if we get a Denied response even when sneakng, stop trying to sneak
chrome.webRequest.onHeadersReceived.addListener(
    function (details) {
        var host = URL(details.url).host();
        if (forbiddenStatusRe.test(details.statusLine)) {
            console.log(details.url + " was forbidden");
            if (host.slice(host.length - sneakSuffix.length) === sneakSuffix) {
                host = host.slice(0, host.length - sneaksuffix);
                model.blacklist(host);
            }
            else {
                console.log(host + " added to damaged list");
                model.whitelist(host);
                chrome.tabs.get(details.tabId, function(tab){
                    if (tab.url === details.url) {
                        chrome.tabs.reload(tab.id);
                    }
                });
            }
        }
    },
    // filters
    {
        urls: ["<all_urls>"]
    }
);




chrome.webRequest.onErrorOccurred.addListener(
    function(details){
        //debugger;
    },
    // filters
    {
        urls: ["<all_urls>"]
    }
);




// handle incoming request from popup
chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
        if (request.sneakDomain) {
            model.whitelist(request.sneakDomain);
            chrome.tabs.reload();
        }
    }
);
























